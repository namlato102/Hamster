<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HamsterRPC: hamster_server.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HamsterRPC
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">remote hamster asylum management system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">hamster_server.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Remote Hamsterverwaltungsprogramm.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;sys/stat.h&gt;</code><br />
<code>#include &lt;fcntl.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
<code>#include &lt;errno.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;inttypes.h&gt;</code><br />
<code>#include &lt;sys/socket.h&gt;</code><br />
<code>#include &lt;netinet/in.h&gt;</code><br />
<code>#include &lt;arpa/inet.h&gt;</code><br />
<code>#include &lt;getopt.h&gt;</code><br />
<code>#include &quot;<a class="el" href="hamsterlib_8h_source.html">../include/hamsterlib.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="hamsterprotocol_8h_source.html">../include/hamsterprotocol.h</a>&quot;</code><br />
</div>
<p><a href="hamster__server_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structmsg_header.html">msgHeader</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">message header structure  <a href="structmsg_header.html#details">More...</a><br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a16b710f592bf8f7900666392adc444dc"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a16b710f592bf8f7900666392adc444dc">DEFAULT_PORT</a>&#160;&#160;&#160;2323</td></tr>
<tr class="memdesc:a16b710f592bf8f7900666392adc444dc"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default port number and IP.  <a href="hamster__server_8c.html#a16b710f592bf8f7900666392adc444dc">More...</a><br /></td></tr>
<tr class="separator:a16b710f592bf8f7900666392adc444dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a34d476f860a832d42ef7c068e243a996"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a34d476f860a832d42ef7c068e243a996">DEFAULT_IP</a>&#160;&#160;&#160;&quot;127.0.0.1&quot;</td></tr>
<tr class="separator:a34d476f860a832d42ef7c068e243a996"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1614f028c1fef258edfb81fb963609cb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>(x)</td></tr>
<tr class="memdesc:a1614f028c1fef258edfb81fb963609cb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Debug support macros.  <a href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">More...</a><br /></td></tr>
<tr class="separator:a1614f028c1fef258edfb81fb963609cb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c8a50c36eafb92fe286daee03652c0e"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a8c8a50c36eafb92fe286daee03652c0e">debug1</a>(x)</td></tr>
<tr class="separator:a8c8a50c36eafb92fe286daee03652c0e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a83c5cecb7f08e28bcf657448cf8aac9b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a83c5cecb7f08e28bcf657448cf8aac9b">debug2</a>(x)</td></tr>
<tr class="separator:a83c5cecb7f08e28bcf657448cf8aac9b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a130e2e7206b378b32e876e1799fcc44a"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a130e2e7206b378b32e876e1799fcc44a">debug3</a>(x)</td></tr>
<tr class="separator:a130e2e7206b378b32e876e1799fcc44a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad486a376b287c513b16f66f723f2a687"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#ad486a376b287c513b16f66f723f2a687">debug4</a>(x)</td></tr>
<tr class="separator:ad486a376b287c513b16f66f723f2a687"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a361a8b662c3b553440f76fce74066236"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a361a8b662c3b553440f76fce74066236">readfromsocket</a> (int sock, unsigned char *buffer, unsigned int bytestoread)</td></tr>
<tr class="memdesc:a361a8b662c3b553440f76fce74066236"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read requested number of bytes from socket.  <a href="hamster__server_8c.html#a361a8b662c3b553440f76fce74066236">More...</a><br /></td></tr>
<tr class="separator:a361a8b662c3b553440f76fce74066236"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6c0646aba56fd92ae104536f8f7da75d"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a6c0646aba56fd92ae104536f8f7da75d">writetosocket</a> (int sock, unsigned char *buffer, unsigned int bytestowrite)</td></tr>
<tr class="memdesc:a6c0646aba56fd92ae104536f8f7da75d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write requested number of bytes to socket.  <a href="hamster__server_8c.html#a6c0646aba56fd92ae104536f8f7da75d">More...</a><br /></td></tr>
<tr class="separator:a6c0646aba56fd92ae104536f8f7da75d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8ca6cc9d597c856fe84ecf7ef3799ee6"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a8ca6cc9d597c856fe84ecf7ef3799ee6">readheader</a> (int sock, struct <a class="el" href="structmsg_header.html">msgHeader</a> *hdr)</td></tr>
<tr class="memdesc:a8ca6cc9d597c856fe84ecf7ef3799ee6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read a message header from socket.  <a href="hamster__server_8c.html#a8ca6cc9d597c856fe84ecf7ef3799ee6">More...</a><br /></td></tr>
<tr class="separator:a8ca6cc9d597c856fe84ecf7ef3799ee6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9b1137c34b10a31bcdff3e5d06af4098"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a9b1137c34b10a31bcdff3e5d06af4098">writeheader</a> (int sock, struct <a class="el" href="structmsg_header.html">msgHeader</a> *hdr)</td></tr>
<tr class="memdesc:a9b1137c34b10a31bcdff3e5d06af4098"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write a message header to socket.  <a href="hamster__server_8c.html#a9b1137c34b10a31bcdff3e5d06af4098">More...</a><br /></td></tr>
<tr class="separator:a9b1137c34b10a31bcdff3e5d06af4098"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0ddf1224851353fc92bfbff6f499fa97"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="hamster__server_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a> (int argc, char *argv[])</td></tr>
<tr class="memdesc:a0ddf1224851353fc92bfbff6f499fa97"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main program.  <a href="hamster__server_8c.html#a0ddf1224851353fc92bfbff6f499fa97">More...</a><br /></td></tr>
<tr class="separator:a0ddf1224851353fc92bfbff6f499fa97"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Remote Hamsterverwaltungsprogramm. </p>

<p class="definition">Definition in file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a1614f028c1fef258edfb81fb963609cb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1614f028c1fef258edfb81fb963609cb">&#9670;&nbsp;</a></span>debug</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define debug</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Debug support macros. </p>
<p>Output messages if <code>verbose</code> is higher than a given level.</p>
<p>NOTE: Usage <code>debug</code>((&lt;printf-params&gt;)); i.e. use <em>two</em> brackets to enclose the printf parameter list! </p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00069">69</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="a8c8a50c36eafb92fe286daee03652c0e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c8a50c36eafb92fe286daee03652c0e">&#9670;&nbsp;</a></span>debug1</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define debug1</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00070">70</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="a83c5cecb7f08e28bcf657448cf8aac9b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a83c5cecb7f08e28bcf657448cf8aac9b">&#9670;&nbsp;</a></span>debug2</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define debug2</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00071">71</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="a130e2e7206b378b32e876e1799fcc44a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a130e2e7206b378b32e876e1799fcc44a">&#9670;&nbsp;</a></span>debug3</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define debug3</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00072">72</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="ad486a376b287c513b16f66f723f2a687"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad486a376b287c513b16f66f723f2a687">&#9670;&nbsp;</a></span>debug4</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define debug4</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00073">73</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="a34d476f860a832d42ef7c068e243a996"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a34d476f860a832d42ef7c068e243a996">&#9670;&nbsp;</a></span>DEFAULT_IP</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_IP&#160;&#160;&#160;&quot;127.0.0.1&quot;</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00034">34</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<a id="a16b710f592bf8f7900666392adc444dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16b710f592bf8f7900666392adc444dc">&#9670;&nbsp;</a></span>DEFAULT_PORT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_PORT&#160;&#160;&#160;2323</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Default port number and IP. </p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00033">33</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a0ddf1224851353fc92bfbff6f499fa97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ddf1224851353fc92bfbff6f499fa97">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>argc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>argv</em>[]&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main program. </p>
<p>Read a header</p>
<p>Now that we know the payload size, read the payload</p>
<p>We are a server, thus we do not expect response or error flags in the messages we receive!</p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00210">210</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;{</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordtype">int</span>  port = <a class="code" href="hamster__server_8c.html#a16b710f592bf8f7900666392adc444dc">DEFAULT_PORT</a>;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordtype">char</span> *host = <a class="code" href="hamster__server_8c.html#a34d476f860a832d42ef7c068e243a996">DEFAULT_IP</a>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="keywordtype">char</span> option;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordtype">char</span> *end;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordtype">int</span>  listensock;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keywordtype">int</span>  sock;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="keywordtype">int</span>  readbytes;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keyword">struct </span>sockaddr_in serv_addr;</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> payload[1024];</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keyword">struct </span><a class="code" href="structmsg_header.html">msgHeader</a> header;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    int32_t retval;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    <span class="comment">// parse arguments</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160; </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="keywordflow">while</span> ((option = getopt(argc, argv, <span class="stringliteral">&quot;?h:p:v&quot;</span>)) != -1)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">switch</span>(option)</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        {</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;                rtfm(argv);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;                <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                port = strtoul(optarg, &amp;end, 0);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                <span class="keywordflow">if</span> (end == optarg)</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                {</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                    rtfm(argv);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                    exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;h&#39;</span>:</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                host = optarg;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">#ifdef EBUG</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                ++verbose;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        }</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">if</span>(argc - optind)</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    {</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        rtfm(argv);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    }</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    printf(<span class="stringliteral">&quot;Running on %s port %d&quot;</span>, host, port);</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="comment">// do stuff</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    listensock = socket(AF_INET, SOCK_STREAM, 0);</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    memset(&amp;serv_addr, <span class="charliteral">&#39;0&#39;</span>, <span class="keyword">sizeof</span>(serv_addr));</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    memset(payload, <span class="charliteral">&#39;0&#39;</span>, <span class="keyword">sizeof</span>(payload)); </div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160; </div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;    serv_addr.sin_family = AF_INET;</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keywordflow">if</span>(!inet_aton(host, &amp;serv_addr.sin_addr))</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    {</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        printf(<span class="stringliteral">&quot;bad IP address: %s\n&quot;</span>, host);</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    }</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    serv_addr.sin_port = htons(port); </div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    bind(listensock, (<span class="keyword">struct</span> sockaddr*)&amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)); </div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    listen(listensock, 5); </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; </div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">while</span>(1)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    {</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        sock = accept(listensock, (<span class="keyword">struct</span> sockaddr*)NULL, NULL);</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">while</span>((retval = <a class="code" href="hamster__server_8c.html#a8ca6cc9d597c856fe84ecf7ef3799ee6">readheader</a>(sock, &amp;header)) == 1)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Received Header:\n&quot;</span>));</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Version:        0x%x\n&quot;</span>, header.version));</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Flags:          0x%x\n&quot;</span>, header.flags));</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;ID:             0x%d\n&quot;</span>, header.msgID));</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;payloadLength:  0x%x\n&quot;</span>, header.payloadLength));</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;callID:         0x%x\n&quot;</span>, header.callID));</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160; </div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            readbytes = <a class="code" href="hamster__server_8c.html#a361a8b662c3b553440f76fce74066236">readfromsocket</a>(sock, payload, header.payloadLength);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Received %d bytes payload:\n&quot;</span>, readbytes));</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            dump(payload, readbytes);</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160; </div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            <span class="keywordflow">if</span>(!!(header.flags &amp; (<a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a> | <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>)))</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            {   </div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;                </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            }</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;            <span class="keywordflow">switch</span>(header.callID)</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;            {</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#gac0935a3a982513c9a21005b657955715">HAMSTER_RPC_FUNCID_NEW</a>:</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#gae62a98851ca33c53c8a94b265b109273">hmstr_new</a>((<span class="keywordtype">char</span>*)&amp;payload[0], (<span class="keywordtype">char</span>*)&amp;payload[32] , ntohs(*((uint16_t*)&amp;payload[64])));</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#ga0e1b8dd2b35607bbcca0d7cfd0beac0a">HAMSTER_RPC_FUNCID_LOOKUP</a>:</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#gade4becec7ffddb5fb1137e872beb3e30">hmstr_lookup</a>((<span class="keywordtype">char</span>*)&amp;payload[0], (<span class="keywordtype">char</span>*)&amp;payload[32]);</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#ga6ecbaf64b675a585655495caff383580">HAMSTER_RPC_FUNCID_DIRECTORY</a>:</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                {</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                    int32_t fd;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                    <span class="keywordtype">char</span>* owner_name = (<span class="keywordtype">char</span>*)&amp;payload[4];</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                    <span class="keywordtype">char</span>* hamster_name = (<span class="keywordtype">char</span>*)&amp;payload[36];</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                    fd = ntohl(*(int32_t*)&amp;payload[0]);</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                    <span class="keywordflow">if</span>(!strlen(owner_name))</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                        owner_name = NULL;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                    <span class="keywordflow">if</span>(!strlen(hamster_name))</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                        hamster_name = NULL;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#gae1d470e57e953b3260452d6fd24506e8">hmstr_directory</a>(&amp;fd, owner_name, hamster_name);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;                    {</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;                    }</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;                    {</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;                        header.payloadLength += <span class="keyword">sizeof</span>(int32_t);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;                        *((int32_t*)&amp;payload[4]) = htonl(fd);</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;                    }</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;                }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#ga6d51f5ed77db4bacdb43c2f4d31cd654">HAMSTER_RPC_FUNCID_HOWSDOING</a>:</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                {</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                    int32_t ID = ntohl(*(int32_t*)&amp;payload[0]);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                    <span class="keyword">struct </span><a class="code" href="structhmstr__state.html">hmstr_state</a> state;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#ga4dab5582d5afdba153007dfdc86d6e21">hmstr_howsdoing</a>(ID, &amp;state);</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                    {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                    }</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;                    {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                        *((uint16_t*)&amp;payload[4]) = htons(state.treats_left);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                        header.payloadLength += <span class="keyword">sizeof</span>(uint16_t);</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                        *((uint32_t*)&amp;payload[6]) = htonl(state.rounds);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                        header.payloadLength += <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;                        *((int16_t*)&amp;payload[10]) = htons(state.cost);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                        header.payloadLength += <span class="keyword">sizeof</span>(int16_t);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                    }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                }</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#gab91e6489c65646ee15db515dabc0fc05">HAMSTER_RPC_FUNCID_READENTRY</a>:</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                    int32_t ID = ntohl(*(int32_t*)&amp;payload[0]);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                    <span class="keywordtype">char</span> *owner_name = (<span class="keywordtype">char</span>*)&amp;payload[4];</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                    <span class="keywordtype">char</span> *hamster_name = (<span class="keywordtype">char</span>*)&amp;payload[36];</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                    int16_t price;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;                    <span class="keywordtype">size_t</span> payloadlength = <span class="keyword">sizeof</span>(uint32_t) + 64 + <span class="keyword">sizeof</span>(int16_t);</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;                    memset(&amp;payload[0], 0, payloadlength);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#ga690ff05b4198e1bf380b7c64aba07791">hmstr_readentry</a>(ID, owner_name, hamster_name, &amp;price);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;                    {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;                        </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                    }</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                    {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                        header.payloadLength = payloadlength;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                        *((int16_t*)&amp;payload[68]) = htons(price);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                    }</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                }</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#ga34bfb44303acc59e8d6cca64ff4a504d">HAMSTER_RPC_FUNCID_GIVETREATS</a>:</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#ga883ae85d23788dd36542a44023cca73d">hmstr_givetreats</a>(ntohl(*((int32_t*)&amp;payload[0])), ntohs(*((int16_t*)&amp;payload[4])));</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;                <span class="keywordflow">case</span> <a class="code" href="group__rpcprot.html#gaa3d0765d129b0c77d524e313191febc2">HAMSTER_RPC_FUNCID_COLLECT</a>:</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;                    retval = <a class="code" href="group__libfuncs.html#ga383bdb192bb06170a76b2fed2df2b87a">hmstr_collect</a>((<span class="keywordtype">char</span>*)&amp;payload[0]);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;                    <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;                        header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;                    header.payloadLength = <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;                    *((uint32_t*)&amp;payload[0]) = htonl(retval);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;                <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                    header.flags = <a class="code" href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a>;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;                    header.flags |= <a class="code" href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a>;</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                    header.payloadLength = 0;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                    <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;            }</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Sending Header:\n&quot;</span>));</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Version:        0x%x\n&quot;</span>, header.version));</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Flags:          0x%x\n&quot;</span>, header.flags));</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;ID:             0x%d\n&quot;</span>, header.msgID));</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;payloadLength:  0x%x\n&quot;</span>, header.payloadLength));</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;callID:         0x%x\n&quot;</span>, header.callID));</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;            <span class="keywordflow">if</span>(<a class="code" href="hamster__server_8c.html#a9b1137c34b10a31bcdff3e5d06af4098">writeheader</a>(sock, &amp;header) != 0)</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                perror(<span class="stringliteral">&quot;write()&quot;</span>);</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                <span class="keywordflow">return</span>(EXIT_FAILURE);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;            <span class="keywordflow">if</span>(header.payloadLength &gt; 0)</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;            {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                <a class="code" href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a>((<span class="stringliteral">&quot;Sending %d bytes payload:\n&quot;</span>, header.payloadLength));</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                dump(payload, header.payloadLength);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;                </div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;                <span class="keywordflow">if</span>(<a class="code" href="hamster__server_8c.html#a6c0646aba56fd92ae104536f8f7da75d">writetosocket</a>(sock, payload, header.payloadLength) != header.payloadLength)</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;                {</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;                    perror(<span class="stringliteral">&quot;write()&quot;</span>);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;                    <span class="keywordflow">return</span>(EXIT_FAILURE);</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;                }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;            }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        }</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordflow">if</span>(retval &lt; 0)</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        {</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;            perror(<span class="stringliteral">&quot;read()&quot;</span>);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;            <span class="keywordflow">return</span>(EXIT_FAILURE);</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        }</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        close(sock);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    }</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    <span class="keywordflow">return</span>(EXIT_SUCCESS);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;}</div>
<div class="ttc" id="agroup__libfuncs_html_ga383bdb192bb06170a76b2fed2df2b87a"><div class="ttname"><a href="group__libfuncs.html#ga383bdb192bb06170a76b2fed2df2b87a">hmstr_collect</a></div><div class="ttdeci">int32_t hmstr_collect(const char *owner_name)</div><div class="ttdoc">Collect all my hamsters and pay the bill.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__collect_8c_source.html#l00038">hmstr_collect.c:38</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_ga4dab5582d5afdba153007dfdc86d6e21"><div class="ttname"><a href="group__libfuncs.html#ga4dab5582d5afdba153007dfdc86d6e21">hmstr_howsdoing</a></div><div class="ttdeci">int32_t hmstr_howsdoing(int32_t ID, struct hmstr_state *state)</div><div class="ttdoc">How is my hamster doing?</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__howsdoing_8c_source.html#l00054">hmstr_howsdoing.c:54</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_ga690ff05b4198e1bf380b7c64aba07791"><div class="ttname"><a href="group__libfuncs.html#ga690ff05b4198e1bf380b7c64aba07791">hmstr_readentry</a></div><div class="ttdeci">int32_t hmstr_readentry(int32_t ID, char *owner, char *name, int16_t *price)</div><div class="ttdoc">Get contents of an entry in the database.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__readentry_8c_source.html#l00031">hmstr_readentry.c:31</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_ga883ae85d23788dd36542a44023cca73d"><div class="ttname"><a href="group__libfuncs.html#ga883ae85d23788dd36542a44023cca73d">hmstr_givetreats</a></div><div class="ttdeci">int32_t hmstr_givetreats(int32_t ID, uint16_t treats)</div><div class="ttdoc">Give treats to my hamster.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__givetreats_8c_source.html#l00034">hmstr_givetreats.c:34</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_gade4becec7ffddb5fb1137e872beb3e30"><div class="ttname"><a href="group__libfuncs.html#gade4becec7ffddb5fb1137e872beb3e30">hmstr_lookup</a></div><div class="ttdeci">int32_t hmstr_lookup(const char *owner_name, const char *hamster_name)</div><div class="ttdoc">Find hamster in the hamstercare institute.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__lookup_8c_source.html#l00033">hmstr_lookup.c:33</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_gae1d470e57e953b3260452d6fd24506e8"><div class="ttname"><a href="group__libfuncs.html#gae1d470e57e953b3260452d6fd24506e8">hmstr_directory</a></div><div class="ttdeci">int32_t hmstr_directory(int32_t *fdptr, const char *owner_name, const char *hamster_name)</div><div class="ttdoc">Get a directory of entries in the database.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__directory_8c_source.html#l00032">hmstr_directory.c:32</a></div></div>
<div class="ttc" id="agroup__libfuncs_html_gae62a98851ca33c53c8a94b265b109273"><div class="ttname"><a href="group__libfuncs.html#gae62a98851ca33c53c8a94b265b109273">hmstr_new</a></div><div class="ttdeci">int32_t hmstr_new(const char *owner_name, const char *hamster_name, uint16_t treats)</div><div class="ttdoc">Put a new hamster into the hamstercare institute.</div><div class="ttdef"><b>Definition:</b> <a href="hmstr__new_8c_source.html#l00063">hmstr_new.c:63</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga0e1b8dd2b35607bbcca0d7cfd0beac0a"><div class="ttname"><a href="group__rpcprot.html#ga0e1b8dd2b35607bbcca0d7cfd0beac0a">HAMSTER_RPC_FUNCID_LOOKUP</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_LOOKUP</div><div class="ttdoc">id for the int32_t hmstr_lookup() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00065">hamsterprotocol.h:65</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga34bfb44303acc59e8d6cca64ff4a504d"><div class="ttname"><a href="group__rpcprot.html#ga34bfb44303acc59e8d6cca64ff4a504d">HAMSTER_RPC_FUNCID_GIVETREATS</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_GIVETREATS</div><div class="ttdoc">id for the int32_t hmstr_givetreats() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00069">hamsterprotocol.h:69</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga606f082699097621f805463c74a18148"><div class="ttname"><a href="group__rpcprot.html#ga606f082699097621f805463c74a18148">HAMSTER_RPC_MASK_FLAG_ERROR</a></div><div class="ttdeci">#define HAMSTER_RPC_MASK_FLAG_ERROR</div><div class="ttdoc">Bit mask for the error flag (set if the message is an error)</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00051">hamsterprotocol.h:51</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga6d51f5ed77db4bacdb43c2f4d31cd654"><div class="ttname"><a href="group__rpcprot.html#ga6d51f5ed77db4bacdb43c2f4d31cd654">HAMSTER_RPC_FUNCID_HOWSDOING</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_HOWSDOING</div><div class="ttdoc">id for the int32_t hmstr_howsdoing() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00067">hamsterprotocol.h:67</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga6ecbaf64b675a585655495caff383580"><div class="ttname"><a href="group__rpcprot.html#ga6ecbaf64b675a585655495caff383580">HAMSTER_RPC_FUNCID_DIRECTORY</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_DIRECTORY</div><div class="ttdoc">id for the int32_t hmstr_directory() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00066">hamsterprotocol.h:66</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga9bacd9645728a80667224691c2c4c8a7"><div class="ttname"><a href="group__rpcprot.html#ga9bacd9645728a80667224691c2c4c8a7">HAMSTER_RPC_MASK_FLAG_RESPONSE</a></div><div class="ttdeci">#define HAMSTER_RPC_MASK_FLAG_RESPONSE</div><div class="ttdoc">Bit mask for the response flag (set if the message is an response)</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00052">hamsterprotocol.h:52</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gaa3d0765d129b0c77d524e313191febc2"><div class="ttname"><a href="group__rpcprot.html#gaa3d0765d129b0c77d524e313191febc2">HAMSTER_RPC_FUNCID_COLLECT</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_COLLECT</div><div class="ttdoc">id for the int32_t hmstr_collect() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00070">hamsterprotocol.h:70</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gab91e6489c65646ee15db515dabc0fc05"><div class="ttname"><a href="group__rpcprot.html#gab91e6489c65646ee15db515dabc0fc05">HAMSTER_RPC_FUNCID_READENTRY</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_READENTRY</div><div class="ttdoc">id for the int32_t hmstr_readentry() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00068">hamsterprotocol.h:68</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gac0935a3a982513c9a21005b657955715"><div class="ttname"><a href="group__rpcprot.html#gac0935a3a982513c9a21005b657955715">HAMSTER_RPC_FUNCID_NEW</a></div><div class="ttdeci">#define HAMSTER_RPC_FUNCID_NEW</div><div class="ttdoc">id for the int32_t hmstr_new() RPC call</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00064">hamsterprotocol.h:64</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a1614f028c1fef258edfb81fb963609cb"><div class="ttname"><a href="hamster__server_8c.html#a1614f028c1fef258edfb81fb963609cb">debug</a></div><div class="ttdeci">#define debug(x)</div><div class="ttdoc">Debug support macros.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00069">hamster_server.c:69</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a16b710f592bf8f7900666392adc444dc"><div class="ttname"><a href="hamster__server_8c.html#a16b710f592bf8f7900666392adc444dc">DEFAULT_PORT</a></div><div class="ttdeci">#define DEFAULT_PORT</div><div class="ttdoc">Default port number and IP.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00033">hamster_server.c:33</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a34d476f860a832d42ef7c068e243a996"><div class="ttname"><a href="hamster__server_8c.html#a34d476f860a832d42ef7c068e243a996">DEFAULT_IP</a></div><div class="ttdeci">#define DEFAULT_IP</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00034">hamster_server.c:34</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a361a8b662c3b553440f76fce74066236"><div class="ttname"><a href="hamster__server_8c.html#a361a8b662c3b553440f76fce74066236">readfromsocket</a></div><div class="ttdeci">int readfromsocket(int sock, unsigned char *buffer, unsigned int bytestoread)</div><div class="ttdoc">Read requested number of bytes from socket.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00099">hamster_server.c:99</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a6c0646aba56fd92ae104536f8f7da75d"><div class="ttname"><a href="hamster__server_8c.html#a6c0646aba56fd92ae104536f8f7da75d">writetosocket</a></div><div class="ttdeci">int writetosocket(int sock, unsigned char *buffer, unsigned int bytestowrite)</div><div class="ttdoc">Write requested number of bytes to socket.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00125">hamster_server.c:125</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a8ca6cc9d597c856fe84ecf7ef3799ee6"><div class="ttname"><a href="hamster__server_8c.html#a8ca6cc9d597c856fe84ecf7ef3799ee6">readheader</a></div><div class="ttdeci">int readheader(int sock, struct msgHeader *hdr)</div><div class="ttdoc">Read a message header from socket.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00146">hamster_server.c:146</a></div></div>
<div class="ttc" id="ahamster__server_8c_html_a9b1137c34b10a31bcdff3e5d06af4098"><div class="ttname"><a href="hamster__server_8c.html#a9b1137c34b10a31bcdff3e5d06af4098">writeheader</a></div><div class="ttdeci">int writeheader(int sock, struct msgHeader *hdr)</div><div class="ttdoc">Write a message header to socket.</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00180">hamster_server.c:180</a></div></div>
<div class="ttc" id="astructhmstr__state_html"><div class="ttname"><a href="structhmstr__state.html">hmstr_state</a></div><div class="ttdoc">Hamster status structure.</div><div class="ttdef"><b>Definition:</b> <a href="hamsterlib_8h_source.html#l00119">hamsterlib.h:120</a></div></div>
<div class="ttc" id="astructmsg_header_html"><div class="ttname"><a href="structmsg_header.html">msgHeader</a></div><div class="ttdoc">message header structure</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00080">hamster_server.c:81</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a361a8b662c3b553440f76fce74066236"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a361a8b662c3b553440f76fce74066236">&#9670;&nbsp;</a></span>readfromsocket()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int readfromsocket </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>bytestoread</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read requested number of bytes from socket. </p>
<p>read() may legally return (and will actually do so when reading from sockets) after reading less than the requested number of bytes. However, here we know how many bytes to expect, so we put a wrapper around read(). </p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00099">99</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;{</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytesread = 0;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remaining;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <span class="keywordtype">int</span> n;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">for</span>(remaining = bytestoread; remaining &gt; 0; remaining -= n)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        n = read(sock, buffer + bytesread, remaining);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        <span class="keywordflow">if</span>(n &lt; 0)</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;            <span class="keywordflow">return</span> n;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        bytesread += n;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keywordflow">if</span>(0 == n)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            <span class="keywordflow">return</span> bytesread;</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    }</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordflow">return</span> bytesread;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a8ca6cc9d597c856fe84ecf7ef3799ee6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8ca6cc9d597c856fe84ecf7ef3799ee6">&#9670;&nbsp;</a></span>readheader()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int readheader </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structmsg_header.html">msgHeader</a> *&#160;</td>
          <td class="paramname"><em>hdr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read a message header from socket. </p>
<p>Read header from socket</p>
<p>Decode header data</p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00146">146</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;{</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[<a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>];</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160; </div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">if</span>((rc = <a class="code" href="hamster__server_8c.html#a361a8b662c3b553440f76fce74066236">readfromsocket</a>(sock, buf, <a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>)) &lt; 0)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <span class="keywordflow">if</span>(0 == rc)</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    }</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rc != <a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    {</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot;readheader: protocol Error!&quot;</span>);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    hdr-&gt;<a class="code" href="structmsg_header.html#a9a26f720c087b8a2e65a075a06e37b29">version</a> = buf[<a class="code" href="group__rpcprot.html#gac20607f62948a95d9901f426b3a0078d">HAMSTER_RPC_PROT_HEADER_VERSION_OFFSET</a>];</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    hdr-&gt;<a class="code" href="structmsg_header.html#adf9377366825b23b15b10de1eb194c2b">flags</a> = buf[<a class="code" href="group__rpcprot.html#ga38c289e4c8fcd2a01d77f79b604b1889">HAMSTER_RPC_PROT_HEADER_FLAGS_OFFSET</a>];</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    hdr-&gt;<a class="code" href="structmsg_header.html#abe2f51387765a7dbb3cb6d1a65fc31bd">msgID</a> = ntohs(*(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#ga3089e577700430eb60cc5754776b2308">HAMSTER_RPC_PROT_HEADER_MSGID_OFFSET</a>]));</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    hdr-&gt;<a class="code" href="structmsg_header.html#a1317a02938249fc9ecd0dbaa17099034">payloadLength</a> = ntohs(*(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#gaebd28d64606c4ce6e75522350ba670d1">HAMSTER_RPC_PROT_HEADER_PAYLOADLENGTH_OFFSET</a>]));</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    hdr-&gt;<a class="code" href="structmsg_header.html#aa173c0e075edc9baadae125a3c4e7586">callID</a> = ntohs(*(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#ga7f2a42c5d7c8446dc57f7383ec8f6719">HAMSTER_RPC_PROT_HEADER_CALLID_OFFSET</a>]));</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;}</div>
<div class="ttc" id="agroup__rpcprot_html_ga3089e577700430eb60cc5754776b2308"><div class="ttname"><a href="group__rpcprot.html#ga3089e577700430eb60cc5754776b2308">HAMSTER_RPC_PROT_HEADER_MSGID_OFFSET</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_MSGID_OFFSET</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00074">hamsterprotocol.h:74</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga38c289e4c8fcd2a01d77f79b604b1889"><div class="ttname"><a href="group__rpcprot.html#ga38c289e4c8fcd2a01d77f79b604b1889">HAMSTER_RPC_PROT_HEADER_FLAGS_OFFSET</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_FLAGS_OFFSET</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00073">hamsterprotocol.h:73</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_ga7f2a42c5d7c8446dc57f7383ec8f6719"><div class="ttname"><a href="group__rpcprot.html#ga7f2a42c5d7c8446dc57f7383ec8f6719">HAMSTER_RPC_PROT_HEADER_CALLID_OFFSET</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_CALLID_OFFSET</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00076">hamsterprotocol.h:76</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gac20607f62948a95d9901f426b3a0078d"><div class="ttname"><a href="group__rpcprot.html#gac20607f62948a95d9901f426b3a0078d">HAMSTER_RPC_PROT_HEADER_VERSION_OFFSET</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_VERSION_OFFSET</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00072">hamsterprotocol.h:72</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gaebd28d64606c4ce6e75522350ba670d1"><div class="ttname"><a href="group__rpcprot.html#gaebd28d64606c4ce6e75522350ba670d1">HAMSTER_RPC_PROT_HEADER_PAYLOADLENGTH_OFFSET</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_PAYLOADLENGTH_OFFSET</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00075">hamsterprotocol.h:75</a></div></div>
<div class="ttc" id="agroup__rpcprot_html_gaebf04e94b1b71498f0038266ccdee5c9"><div class="ttname"><a href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a></div><div class="ttdeci">#define HAMSTER_RPC_PROT_HEADER_SIZE</div><div class="ttdoc">Size in byte of the RPC protocol header.</div><div class="ttdef"><b>Definition:</b> <a href="hamsterprotocol_8h_source.html#l00043">hamsterprotocol.h:43</a></div></div>
<div class="ttc" id="astructmsg_header_html_a1317a02938249fc9ecd0dbaa17099034"><div class="ttname"><a href="structmsg_header.html#a1317a02938249fc9ecd0dbaa17099034">msgHeader::payloadLength</a></div><div class="ttdeci">uint16_t payloadLength</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00085">hamster_server.c:85</a></div></div>
<div class="ttc" id="astructmsg_header_html_a9a26f720c087b8a2e65a075a06e37b29"><div class="ttname"><a href="structmsg_header.html#a9a26f720c087b8a2e65a075a06e37b29">msgHeader::version</a></div><div class="ttdeci">uint8_t version</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00082">hamster_server.c:82</a></div></div>
<div class="ttc" id="astructmsg_header_html_aa173c0e075edc9baadae125a3c4e7586"><div class="ttname"><a href="structmsg_header.html#aa173c0e075edc9baadae125a3c4e7586">msgHeader::callID</a></div><div class="ttdeci">uint16_t callID</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00086">hamster_server.c:86</a></div></div>
<div class="ttc" id="astructmsg_header_html_abe2f51387765a7dbb3cb6d1a65fc31bd"><div class="ttname"><a href="structmsg_header.html#abe2f51387765a7dbb3cb6d1a65fc31bd">msgHeader::msgID</a></div><div class="ttdeci">uint16_t msgID</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00084">hamster_server.c:84</a></div></div>
<div class="ttc" id="astructmsg_header_html_adf9377366825b23b15b10de1eb194c2b"><div class="ttname"><a href="structmsg_header.html#adf9377366825b23b15b10de1eb194c2b">msgHeader::flags</a></div><div class="ttdeci">uint8_t flags</div><div class="ttdef"><b>Definition:</b> <a href="hamster__server_8c_source.html#l00083">hamster_server.c:83</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a9b1137c34b10a31bcdff3e5d06af4098"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9b1137c34b10a31bcdff3e5d06af4098">&#9670;&nbsp;</a></span>writeheader()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int writeheader </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structmsg_header.html">msgHeader</a> *&#160;</td>
          <td class="paramname"><em>hdr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write a message header to socket. </p>
<p>Encode header data</p>
<p>Write header to socket</p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00180">180</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;{</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[<a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>];</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    buf[<a class="code" href="group__rpcprot.html#gac20607f62948a95d9901f426b3a0078d">HAMSTER_RPC_PROT_HEADER_VERSION_OFFSET</a>] = hdr-&gt;<a class="code" href="structmsg_header.html#a9a26f720c087b8a2e65a075a06e37b29">version</a>;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    buf[<a class="code" href="group__rpcprot.html#ga38c289e4c8fcd2a01d77f79b604b1889">HAMSTER_RPC_PROT_HEADER_FLAGS_OFFSET</a>] = hdr-&gt;<a class="code" href="structmsg_header.html#adf9377366825b23b15b10de1eb194c2b">flags</a>;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    *(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#ga3089e577700430eb60cc5754776b2308">HAMSTER_RPC_PROT_HEADER_MSGID_OFFSET</a>]) = htons(hdr-&gt;<a class="code" href="structmsg_header.html#abe2f51387765a7dbb3cb6d1a65fc31bd">msgID</a>);</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    *(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#gaebd28d64606c4ce6e75522350ba670d1">HAMSTER_RPC_PROT_HEADER_PAYLOADLENGTH_OFFSET</a>]) = htons(hdr-&gt;<a class="code" href="structmsg_header.html#a1317a02938249fc9ecd0dbaa17099034">payloadLength</a>);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    *(uint16_t*)(&amp;buf[<a class="code" href="group__rpcprot.html#ga7f2a42c5d7c8446dc57f7383ec8f6719">HAMSTER_RPC_PROT_HEADER_CALLID_OFFSET</a>]) = htons(hdr-&gt;<a class="code" href="structmsg_header.html#aa173c0e075edc9baadae125a3c4e7586">callID</a>);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span>((rc = <a class="code" href="hamster__server_8c.html#a6c0646aba56fd92ae104536f8f7da75d">writetosocket</a>(sock, buf, <a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>)) &lt; 0)</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        <span class="keywordflow">return</span> rc;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">if</span>(rc != <a class="code" href="group__rpcprot.html#gaebf04e94b1b71498f0038266ccdee5c9">HAMSTER_RPC_PROT_HEADER_SIZE</a>)</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    {</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        fprintf(stderr, <span class="stringliteral">&quot;writeheader: protocol Error!&quot;</span>);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a6c0646aba56fd92ae104536f8f7da75d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6c0646aba56fd92ae104536f8f7da75d">&#9670;&nbsp;</a></span>writetosocket()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int writetosocket </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>sock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>bytestowrite</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Write requested number of bytes to socket. </p>
<p>write() may legally return (and will actually do so when writing to sockets) having written less than the requested number of bytes. However, here we know how many bytes want to write, so we put a wrapper around write(). </p>

<p class="definition">Definition at line <a class="el" href="hamster__server_8c_source.html#l00125">125</a> of file <a class="el" href="hamster__server_8c_source.html">hamster_server.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;{</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> byteswritten = 0;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> remaining;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordtype">int</span> n;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="keywordflow">for</span>(remaining = bytestowrite; remaining &gt; 0; remaining -= n)</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    {</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        n = write(sock, buffer + byteswritten, remaining);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span>(n &lt; 0)</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="keywordflow">return</span> n;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        byteswritten += n;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        <span class="keywordflow">if</span>(0 == n)</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            <span class="keywordflow">return</span> byteswritten;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    }</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">return</span> byteswritten;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Apr 4 2023 11:30:02 for HamsterRPC by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
